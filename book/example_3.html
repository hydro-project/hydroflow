<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A Example With Streaming Input - The Hydroflow Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="quickstart.html"><strong aria-hidden="true">1.</strong> Quickstart</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="example_1.html"><strong aria-hidden="true">1.2.</strong> Simplest Example</a></li><li class="chapter-item expanded "><a href="example_2.html"><strong aria-hidden="true">1.3.</strong> Simple Example</a></li><li class="chapter-item expanded "><a href="example_3.html" class="active"><strong aria-hidden="true">1.4.</strong> A Example With Streaming Input</a></li><li class="chapter-item expanded "><a href="example_4.html"><strong aria-hidden="true">1.5.</strong> Graph Reachability</a></li><li class="chapter-item expanded "><a href="example_5.html"><strong aria-hidden="true">1.6.</strong> Graph Un-Reachability</a></li></ol></li><li class="chapter-item expanded "><a href="concepts.html"><strong aria-hidden="true">2.</strong> Concepts</a></li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">3.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="in-out_trees.html"><strong aria-hidden="true">3.1.</strong> Subgraph In-Out Trees</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Hydroflow Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="an-example-with-streaming-input"><a class="header" href="#an-example-with-streaming-input">An Example With Streaming Input</a></h1>
<p>In this example we'll introduce the concept of handoffs and external inputs.</p>
<pre><pre class="playground"><code class="language-rust">use hydroflow::builder::prelude::*;

pub fn main() {
    let mut builder = HydroflowBuilder::new();

    // code will go here

    let mut hydroflow = builder.build();
    hydroflow.run_available();
}
</code></pre></pre>
<p>We'll start out with the above boilerplate. To add a new external input
channel, we can call the <a href="https://hydro-project.github.io/hydroflow/doc/hydroflow/builder/struct.HydroflowBuilder.html#method.add_channel_input"><code>builder.add_channel_input()</code></a>
method. The method requires several type parameters as well as a human-friendly
name for debugging, and returns a tuple of an input for feeding in items and a
output for receiving items into the subgraph.</p>
<pre><code class="language-rust ignore">let (input_example, example_recv) =
    builder.add_channel_input::&lt;_, Option&lt;usize&gt;, VecHandoff&lt;usize&gt;&gt;(
        &quot;My example input&quot;
    );
</code></pre>
<p>The Rust <code>::&lt;_, Option&lt;usize&gt;, VecHandoff&lt;usize&gt;&gt;</code> syntax is affectionately
called the &quot;turbofish&quot; and is how type parameters (generic arguments) are
supplied to generic types and functions. In this case the first type argument
is the label type, and by supplying an underscore <code>_</code> we leave it up to the
compiler to infer the type. The second and third type parameters are more
important.</p>
<p>The second type parameter, <code>Option&lt;usize&gt;</code>, specifies what we will be sending
into the input channel. Even though the input will be for <code>usize</code>s, we specify
<code>Option</code>s instead. This extra layer of abstraction allows us to pass in both
individual elements (via <a href="https://doc.rust-lang.org/stable/std/option/enum.Option.html"><code>Option</code></a>
or <a href="https://hydro-project.github.io/hydroflow/doc/hydroflow/lang/collections/struct.Single.html"><code>Single</code></a>)
or full iterators via <a href="https://hydro-project.github.io/hydroflow/doc/hydroflow/lang/collections/struct.Iter.html"><code>Iter</code></a>.</p>
<p>This syntax is a little verbose and clunky, and is subject to change in the
future.</p>
<p>Finally, the third type parameter is the <em>handoff</em> type. A handoff is a buffer
which stores elements as they wait to be processed. Handoffs are mainly used as
buffers between subgraphs, but in this case it is used to store the external
inputs until the subgraph is ready to process them.
Currently <a href="https://hydro-project.github.io/hydroflow/doc/hydroflow/scheduled/handoff/struct.VecHandoff.html"><code>VecHandoff&lt;T&gt;</code></a>
is the main and only handoff type, but in the future we may implement more
specialized handoffs.</p>
<p>The returned <code>example_recv</code> value can be chained on the build a Hydroflow
subgraph just like before. Here is the same program as before, but using the
input channel:</p>
<pre><pre class="playground"><code class="language-rust">use hydroflow::builder::prelude::*;

pub fn main() {
    let mut builder = HydroflowBuilder::new();

    // Create our channel input.
    let (input_example, example_recv) =
        builder.add_channel_input::&lt;_, Option&lt;usize&gt;, VecHandoff&lt;usize&gt;&gt;(
            &quot;My example input&quot;
        );

    builder.add_subgraph(
        &quot;main&quot;,
        example_recv
            .flatten() // Huh?!
            .map(|n| n * n)
            .filter(|&amp;n| n &gt; 10)
            .pull_to_push()
            .flat_map(|n| (n..=n + 1))
            .for_each(|n| println!(&quot;Ahoj {}&quot;, n)),
    );

    let mut hydroflow = builder.build();

    println!(&quot;A&quot;);
    input_example.give(Some(0));
    input_example.give(Some(1));
    input_example.give(Some(2));
    input_example.give(Some(3));
    input_example.give(Some(4));
    input_example.give(Some(5));
    input_example.flush();

    hydroflow.run_available();

    println!(&quot;B&quot;);
    input_example.give(Some(6));
    input_example.give(Some(7));
    input_example.give(Some(8));
    input_example.give(Some(9));
    input_example.flush();

    hydroflow.run_available();
}
</code></pre></pre>
<pre><code class="language-txt">A
Ahoj 16
Ahoj 17
Ahoj 25
Ahoj 26
B
Ahoj 36
Ahoj 37
Ahoj 49
Ahoj 50
Ahoj 64
Ahoj 65
Ahoj 81
Ahoj 82
</code></pre>
<p>At the bottom we can see supplying inputs with <code>.give(Option)</code>. And
importantly, make sure to call <code>.flush()</code>!</p>
<p>Unlike the previous example, there's an extra <code>.flatten()</code> directly after
starting with <code>example_recv</code>. This is because the handoff actually returns its
entire buffer as one element (a <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code>VecDeque&lt;T&gt;</code></a>)
rather than returning each element individually. This lets us process the data
as a batch if needed, but most of the time we'll just call <code>.flatten()</code> to
convert back into individual elements.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="example_2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="example_4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="example_2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="example_4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
    </body>
</html>
