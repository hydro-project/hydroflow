<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Graph Neighbors - The Hydroflow Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="quickstart.html"><strong aria-hidden="true">2.</strong> Quickstart</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">2.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="example_1_simplest.html"><strong aria-hidden="true">2.2.</strong> Simplest Example</a></li><li class="chapter-item expanded "><a href="example_2_simple.html"><strong aria-hidden="true">2.3.</strong> Simple Example</a></li><li class="chapter-item expanded "><a href="example_3_stream.html"><strong aria-hidden="true">2.4.</strong> A Example With Streaming Input</a></li><li class="chapter-item expanded "><a href="example_4_neighbors.html" class="active"><strong aria-hidden="true">2.5.</strong> Graph Neighbors</a></li><li class="chapter-item expanded "><a href="example_5_reachability.html"><strong aria-hidden="true">2.6.</strong> Graph Reachability</a></li><li class="chapter-item expanded "><a href="example_6_unreachability.html"><strong aria-hidden="true">2.7.</strong> Graph Un-Reachability</a></li><li class="chapter-item expanded "><a href="example_7_echo_server.html"><strong aria-hidden="true">2.8.</strong> Networked Services 1: EchoServer</a></li><li class="chapter-item expanded "><a href="example_8_chat_server.html"><strong aria-hidden="true">2.9.</strong> Networked Services 2: ChatServer</a></li></ol></li><li class="chapter-item expanded "><a href="surface_syntax.html"><strong aria-hidden="true">3.</strong> Syntax</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="surface_embedding.html"><strong aria-hidden="true">3.1.</strong> Rust Embedding</a></li><li class="chapter-item expanded "><a href="surface_flows.html"><strong aria-hidden="true">3.2.</strong> Flows</a></li><li class="chapter-item expanded "><a href="surface_data.html"><strong aria-hidden="true">3.3.</strong> Data Sources</a></li><li class="chapter-item expanded "><a href="surface_ops.gen.html"><strong aria-hidden="true">3.4.</strong> Operators</a></li><li class="chapter-item expanded "><a href="state.html"><strong aria-hidden="true">3.5.</strong> State and Lifetimes</a></li></ol></li><li class="chapter-item expanded "><a href="ecosystem.html"><strong aria-hidden="true">4.</strong> The Hydro Ecosystem</a></li><li class="chapter-item expanded "><a href="concepts.html"><strong aria-hidden="true">5.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="life_and_times.html"><strong aria-hidden="true">5.1.</strong> Life and Times of Hydroflow</a></li><li class="chapter-item expanded "><a href="stratification.html"><strong aria-hidden="true">5.2.</strong> Blocking Ops and Stratification</a></li><li class="chapter-item expanded "><a href="distributed_time.html"><strong aria-hidden="true">5.3.</strong> Distributed Time</a></li><li class="chapter-item expanded "><a href="debugging.html"><strong aria-hidden="true">5.4.</strong> Debugging Hydroflow</a></li><li class="chapter-item expanded "><a href="error_handling.html"><strong aria-hidden="true">5.5.</strong> Error Handling</a></li></ol></li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">6.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scheduling.html"><strong aria-hidden="true">6.1.</strong> Scheduling</a></li><li class="chapter-item expanded "><a href="handoffs.html"><strong aria-hidden="true">6.2.</strong> Handoffs</a></li><li class="chapter-item expanded "><a href="networking.html"><strong aria-hidden="true">6.3.</strong> Networking</a></li><li class="chapter-item expanded "><a href="in-out_trees.html"><strong aria-hidden="true">6.4.</strong> Subgraph In-Out Trees</a></li></ol></li><li class="chapter-item expanded "><a href="lattices_crate.html"><strong aria-hidden="true">7.</strong> The Lattices Crate</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lattice_math.html"><strong aria-hidden="true">7.1.</strong> Lattice Math</a></li></ol></li><li class="chapter-item expanded "><a href="todo.html"><strong aria-hidden="true">8.</strong> TODO</a></li><li class="chapter-item expanded "><a href="faq.html"><strong aria-hidden="true">9.</strong> FAQ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Hydroflow Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="graph-neighbors"><a class="header" href="#graph-neighbors">Graph Neighbors</a></h1>
<blockquote>
<p>In this example we cover:</p>
<ul>
<li>Assigning sub-flows to variables</li>
<li>Our first multi-input operator, <a href="./surface_ops.gen.html#join"><code>join</code></a></li>
<li>Indexing multi-input operators by prepending a bracket expression</li>
<li>The <a href="./surface_ops.gen.html#unique"><code>unique</code></a> operator for removing duplicates from a stream</li>
<li>Visualizing hydroflow code via <code>flow.meta_graph().to_mermaid()</code></li>
<li>A first exposure to the concepts of <em>strata</em> and <em>ticks</em></li>
</ul>
</blockquote>
<p>So far all the operators we've used have one input and one output and therefore
create a linear flow of operators. Let's now take a look at a Hydroflow program containing
an operator which has multiple inputs; in the following examples we'll extend this to
multiple outputs.</p>
<p>To motivate this, we are going to start out on a little project of building a flow-based algorithm 
for the problem of <em>graph reachability</em>. 
Given an abstract graph—represented as data in the form of a streaming list of edges—which 
vertices can be reached from a vertex passed in as the <code>origin</code>? It turns out this is fairly 
naturally represented as a dataflow program. </p>
<blockquote>
<p><strong>Note on terminology</strong>: In each of the next few examples, we're going to write a Hydroflow program (a dataflow graph) to process data that itself represents some other graph! To avoid confusion, in these examples, we'll refer to the Hydroflow program as a &quot;flow&quot; or &quot;program&quot;, and the data as a &quot;graph&quot; of &quot;edges&quot; and &quot;vertices&quot;.</p>
</blockquote>
<h2 id="but-first-graph-neighbors"><a class="header" href="#but-first-graph-neighbors">But First: Graph Neighbors</a></h2>
<p>Graph reachability exercises a bunch of concepts at once, so we'll start here with a simpler flow that 
finds graph <em>neighbors</em>: vertices that are just one hop away. </p>
<p>Our graph neighbors Hydroflow program will take
our initial <code>origin</code> vertex as one input, and join it another input that streams in all the edges—this 
join will stream out the vertices that are one hop (edge) away from the starting vertex. </p>
<p>Here is an <em>intuitive</em> diagram of that dataflow program (we'll see complete, autogenerated Hydroflow diagrams
below):</p>
<pre class="mermaid">graph TD
  subgraph sources
    01[Stream of Edges]
  end
  subgraph neighbors of origin
    00[Origin Vertex]
    20(&quot;V ⨝ E&quot;)
    40[Output]

    00 --&gt; 20
    
    01 ---&gt; 20
    20 --&gt; 40
    
  end
</pre>
<p>Lets take a look at some Hydroflow code that implements the program. In your <code>simple</code> project,
replace the contents of <code>src/main.rs</code> with the following:</p>
<pre><pre class="playground"><code class="language-rust">use hydroflow::hydroflow_syntax;

pub fn main() {
    // An edge in the input data = a pair of `usize` vertex IDs.
    let (edges_send, edges_recv) = hydroflow::util::unbounded_channel::&lt;(usize, usize)&gt;();

    let mut flow = hydroflow_syntax! {
        // inputs: the origin vertex (vertex 0) and stream of input edges
        origin = source_iter(vec![0]);
        stream_of_edges = source_stream(edges_recv);

        // the join
        my_join = join() -&gt; flat_map(|(src, (_, dst))| [src, dst]);
        origin -&gt; map(|v| (v, ())) -&gt; [0]my_join;
        stream_of_edges -&gt; [1]my_join;

        // the output
        my_join -&gt; unique() -&gt; for_each(|n| println!(&quot;Reached: {}&quot;, n));
    };

    println!(
        &quot;{}&quot;,
        flow.meta_graph()
            .expect(&quot;No graph found, maybe failed to parse.&quot;)
            .to_mermaid()
    );
    edges_send.send((0, 1)).unwrap();
    edges_send.send((2, 4)).unwrap();
    edges_send.send((3, 4)).unwrap();
    edges_send.send((1, 2)).unwrap();
    edges_send.send((0, 3)).unwrap();
    edges_send.send((0, 3)).unwrap();
    flow.run_available();
}</code></pre></pre>
<p>Run the program and focus on the last three lines of output, which come from <code>flow.run_available()</code>:</p>
<pre><code class="language-console">% cargo run
&lt;build output&gt;
&lt;graph output&gt;
Reached: 0
Reached: 3
Reached: 1
</code></pre>
<p>That looks right: the edges we &quot;sent&quot; into the flow that start at <code>0</code> are 
<code>(0, 1)</code> and <code>(0, 3)</code>, so the nodes reachable from <code>0</code> in 0 or 1 hops are <code>0, 1, 3</code>.</p>
<blockquote>
<p>Note: When you run the program you may see the lines printed out in a different order. That's OK; the flow we're defining here is producing a <code>set</code> of nodes, so the order in which they are printed out is not specified. The <a href="./surface_ops.gen.html#sort_by"><code>sort_by</code></a> operator can be used to sort the output of a flow.</p>
</blockquote>
<h2 id="examining-the-hydroflow-code"><a class="header" href="#examining-the-hydroflow-code">Examining the Hydroflow Code</a></h2>
<p>In the code, we want to start out with the origin vertex, <code>0</code>,
and the stream of edges coming in. Because this flow is a bit more complex
than our earlier examples, we break it down into named &quot;subflows&quot;, assigning them variable
names that we can reuse. Here we specify two subflows, <code>origin</code> and <code>stream_of_edges</code>:</p>
<pre><code class="language-rust ignore">    origin = source_iter(vec![0]);
    stream_of_edges = source_stream(edges_recv);</code></pre>
<p>The Rust syntax <code>vec![0]</code> constructs a vector with a single element, <code>0</code>, which we iterate
over using <code>source_iter</code>.</p>
<p>We then set up a <a href="./surface_ops.gen.html#join"><code>join()</code></a> that we
name <code>my_join</code>, which acts like a SQL inner join. </p>
<pre><code class="language-rust ignore">    // the join
    my_join = join() -&gt; flat_map(|(src, (_, dst))| [src, dst]);
    origin -&gt; map(|v| (v, ())) -&gt; [0]my_join;
    stream_of_edges -&gt; [1]my_join;</code></pre>
<p>First, note the syntax for passing data into a subflow with multiple inputs requires us to <em>prepend</em> 
an input index (starting at <code>0</code>) in square brackets to the multi-input variable name or operator.  In this example we have <code>-&gt; [0]my_join</code>
and <code>-&gt; [1]my_join</code>.</p>
<p>Hydroflow's <code>join()</code> API requires
a little massaging of its inputs to work properly.
The inputs must be of the form of a pair of elements <code>(K, V1)</code>
and <code>(K, V2)</code>, and the operator joins them on equal keys <code>K</code> and produces an
output of <code>(K, (V1, V2))</code> elements. In this case we only want to join on the key <code>v</code> and
don't have any corresponding value, so we feed <code>origin</code> through a <a href="./surface_ops.gen.html#map"><code>map()</code></a>
to generate <code>(v, ())</code> elements as the first join input. </p>
<p>The <code>stream_of_edges</code> are <code>(src, dst)</code> pairs,
so the join's output is <code>(src, ((), dst))</code> where <code>dst</code> are new neighbor
vertices. So the <code>my_join</code> variable feeds the output of the join through a <code>flat_map</code> to extract the pairs into 2-item arrays, which are flattened to give us a list of all vertices reached.
Finally we print the neighbor vertices as follows:</p>
<pre><code class="language-rust ignore">    my_join -&gt; unique() -&gt; for_each(|n| println!(&quot;Reached: {}&quot;, n));</code></pre>
<p>The <a href="./surface_ops.gen.html#unique">unique</a> operator removes duplicates from the stream to make things more readable. Note that <code>unique</code> does not run in a streaming fashion, which we will talk about more <a href="#strata-and-ticks">below</a>.</p>
<p>There's
also some extra code here, <code>flow.meta_graph().expect(...).to_mermaid()</code>, which tells
Hydroflow to
generate a diagram rendered by <a href="https://mermaid-js.github.io/">Mermaid</a> showing
the structure of the graph, and print it to stdout. You can copy that text and paste it into the <a href="https://mermaid-js.github.io/mermaid-live-editor/">Mermaid Live Editor</a> to see the graph, which should look as follows:</p>
<pre class="mermaid">%%{init: {'theme': 'base', 'themeVariables': {'clusterBkg':'#ddd'}}}%%
flowchart TD
classDef pullClass fill:#02f,color:#fff,stroke:#000
classDef pushClass fill:#ff0,stroke:#000
linkStyle default stroke:#aaa,stroke-width:4px,color:red,font-size:1.5em;
subgraph &quot;sg_1v1 stratum 0&quot;
    1v1[\&quot;(1v1) &lt;tt&gt;source_iter(vec! [0])&lt;/tt&gt;&quot;/]:::pullClass
    2v1[\&quot;(2v1) &lt;tt&gt;source_stream(edges_recv)&lt;/tt&gt;&quot;/]:::pullClass
    5v1[\&quot;(5v1) &lt;tt&gt;map(| v | (v, ()))&lt;/tt&gt;&quot;/]:::pullClass
    3v1[\&quot;(3v1) &lt;tt&gt;join()&lt;/tt&gt;&quot;/]:::pullClass
    4v1[\&quot;(4v1) &lt;tt&gt;flat_map(| (src, (_, dst)) | [src, dst])&lt;/tt&gt;&quot;/]:::pullClass
    1v1---&gt;5v1
    2v1--1---&gt;3v1
    5v1--0---&gt;3v1
    3v1---&gt;4v1
end
subgraph &quot;sg_2v1 stratum 1&quot;
    6v1[/&quot;(6v1) &lt;tt&gt;unique()&lt;/tt&gt;&quot;\]:::pushClass
    7v1[/&quot;(7v1) &lt;tt&gt;for_each(| n | println! (&amp;quot;Reached: {}&amp;quot;, n))&lt;/tt&gt;&quot;\]:::pushClass
    6v1---&gt;7v1
end
4v1---&gt;8v1
8v1[&quot;(8v1) &lt;tt&gt;handoff&lt;/tt&gt;&quot;]:::otherClass
8v1===o6v1
</pre>
<p>Notice in the mermaid graph how Hydroflow separates the <code>unique</code> operator and its downstream dependencies into their own
<em>stratum</em> (plural: <em>strata</em>). Note also the edge coming into <code>unique</code> is bold and ends in a ball: this is because the input to <code>unique</code> is 
``blocking'', meaning that <code>unique</code> should not run until all of the input on that edge has been received.
The stratum boundary before <code>unique</code> ensures that the blocking property is respected.</p>
<p>You may also be wondering why the nodes in the graph have different colors (and shapes, for readers who cannot distinguish
colors easily). The answer has nothing to do with the meaning of the program, only with the way that Hydroflow compiles 
operators into Rust. Simply put, blue (wide-topped) boxes <em>pull</em> data, yellow (wide-bottomed) boxes <em>push</em> data, and the <code>handoff</code> is a special operator that buffers pushed data for subsequent pulling. Hydroflow always places a handoff
between a push producer and a pull consumer, for reasons explained in the <a href="./architecture.html">Architecture</a> chapter.</p>
<h2 id="strata-and-ticks"><a class="header" href="#strata-and-ticks">Strata and Ticks</a></h2>
<p>Hydroflow runs each stratum
in order, one at a time, ensuring all values are computed
before moving on to the next stratum. Between strata we see a <em>handoff</em>, which logically buffers the 
output of the first stratum, and delineates the separation of execution between the 2 strata.</p>
<p>After all strata are run, Hydroflow returns to the first stratum; this begins the next <em>tick</em>. This doesn't really matter for this example, but it is important for long-running Hydroflow services that accept input from the outside world. More on this topic in the chapter on <a href="./life_and_times.html">time</a>.</p>
<p>Returning to the code, if you read the <code>edges_send</code> calls carefully, you'll see that the example data 
has vertices (<code>2</code>, <code>4</code>) that are more than one hop away from <code>0</code>, which were
not output by our simple program. To extend this example to graph <em>reachability</em>, 
we need to recurse: find neighbors of our neighbors, neighbors of our neighbors' neighbors, and so on. In Hydroflow,
this is done by adding a loop to the flow, as we'll see in our <a href="example_5_reachability.html">next example</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="example_3_stream.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="example_5_reachability.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="example_3_stream.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="example_5_reachability.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </div>
    </body>
</html>
